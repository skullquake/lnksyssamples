<div style="height:100%">
	<style>
		#editor{
			position:absolute;
			top:0px;
			right:0px;
			bottom:0px;
			left:0px;
			/* max-height:100%!important; */
			height:100%!important;
			max-height:100%!important;
		}
		input, select { font-size: 100%; }
	</style>
	<div id='editor' style="height:100%!important;"></div>
	<script>
		function save(editor,filename){
			//panel.setHeaderTitle(filename+' [Saving]');
			editor.getValue()
			window.terminal.echo("saving...")
			$.ajax(
				"/filepost.js",
				{
					data:JSON.stringify({cmd:'save','file':filename,'contents':editor.getValue()}),
					contentType:'application/json',
					type:'POST'
				}
			).done(
				$.proxy(function(data){
					//panel.setHeaderTitle(filename+' [Saving]');
					window.terminal.echo("done")
					window.terminal.echo(data)
					//editor.setValue(data);
				},this)
			).fail(
				$.proxy(this,function(e){
					window.terminal.echo("error")
				})
			);
		};
		function exec(editor,filename){
			window.terminal.echo("executing...")
			var body={cmd:'dbeval '+filename};
			$.ajax(
				"/xaspost.js?qwer=qwer",
				{
					data:JSON.stringify(body),
					contentType:'application/json',
					type:'POST'
				}
			).done(
				$.proxy(function(data){
					window.terminal.echo("done")
					lnksys.ui.feedback.process(data);
				},this)
			).fail(
				$.proxy(this,function(e){
					window.terminal.echo("error")
				})
			);
		};

		function main(args){
			window.terminal.echo("Opening "+args.file+"...");
			args=args==null?{}:args;
			args.value=args.value==null?'':args.value;
			//get parent dom node
			var scriptTag=document.getElementsByTagName('script');
			scriptTag=scriptTag[scriptTag.length-1];
			var parentNode=scriptTag.parentNode;
			if(parentNode!=null){
				var panel=jsPanel
					.getPanels()
					.filter(
						function(a){
							return a.id==$(parentNode).closest('.jsPanel').attr('id');
						}
					)[0]
				;
				panel.setHeaderTitle(args.file+"[Opening...]");
				window.panel=panel;
				window.parentNode=parentNode;
				window.terminal.focus();

				//setup ace
				ace.config.set('basePath','/res/js/ace');
				var divEditor=$(parentNode).find('#editor')[0];
				var editor=ace.edit(divEditor);
				/*
    var heightUpdateFunction = function() {
        // http://stackoverflow.com/questions/11584061/
        var newHeight =
                  editor.getSession().getScreenLength()
                  * editor.renderer.lineHeight
                  + editor.renderer.scrollBar.getWidth();

        $('#editor').height(newHeight.toString() + "px");
        $('#editor-section').height(newHeight.toString() + "px");

        // This call is required for the editor to fix all of
        // its inner structure for adapting to a change in size
        editor.resize();
    };

    // Set initial size to match initial content
    heightUpdateFunction();

    // Whenever a change happens inside the ACE editor, update
    // the size again
    editor.getSession().on('change', heightUpdateFunction);
    */
/*
//var editor = ace.edit("editor");                   // the editor object
//var editorDiv = document.getElementById("editor");     // its container
var editorDiv = parentNode;//document.getElementById("editor");     // its container
var doc = editor.getSession().getDocument();  // a reference to the doc

editor.on("change", function() {
    var lineHeight = editor.renderer.lineHeight;
    editorDiv.style.height = lineHeight * doc.getLength() + "px";
    editor.resize();
});
*/
editor.on("change", function() {
	console.log('edtchg');
});

				editor.setKeyboardHandler("ace/keyboard/vim");
				ace.config.loadModule(
					'ace/keyboard/vim',
					$.proxy(function(module){
						var VimApi = module.CodeMirror.Vim;
						VimApi.defineEx(
							'w',//a.str_cmd,
							'w',//a.str_cmd,
							$.proxy(function(cm,input){
								save(editor,args.file);
								/*
								var argString=null;
								if(
									input.args!=null
								){
									argString=input.args.splice(0,input.args.length-1).join(' ')
								}else{
									argString=input.argString;
								}
								*/
								/*
								cm.openNotification(
									'<span style="color: red">'+
									str+
									'</span>',
									{bottom: true, duration: 5000}
								);
								*/
							},this)
						);
						VimApi.defineEx(
							'q',//a.str_cmd,
							'q',//a.str_cmd,
							$.proxy(function(cm,input){
								editor.destroy();
								$(window.terminal).find("textarea").focus();
								window.terminal.focus();
								panel.close();
							},this)
						);
						VimApi.defineEx(
							'r',//a.str_cmd,
							'r',//a.str_cmd,
							$.proxy(function(cm,input){
								exec(editor,args.file);
							},this)
						);

					},this)
				);
				function hdlrsz(){
					var numLines=Math.floor($(panel.content).height()/$(editor.container).find(".ace_gutter-cell").height());;
					console.log(numLines);
					editor.setOptions(
						{
							maxLines:numLines,//Math.floor($(panel).height()/editor.getFontSize()),
							minLines:numLines,//Math.floor($(panel).height()/editor.getFontSize())
						}
					);
				}
				//panel.options.dragit.stop.push($.proxy(hdlrsz,this));
				panel.options.resizeit.stop.push($.proxy(hdlrsz,this));
				editor.setTheme("ace/theme/monokai");

				//terminal issue: unfocus
				window.terminal.blur();
				window.terminal.disable();
				editor.focus();
				panel.setHeaderTitle(args.file);
				editor.setValue(args.value);
				//save
				editor.commands.addCommand(
					{
						name: 'save',
						bindKey: {
							win: 'Alt-W', mac: 'Command-W',
							sender: 'editor|cli'
						},
						exec:$.proxy(
							function(env,args,request){
								save(editor,args.file);
							},
							this
						)
					}
				)
				editor.commands.addCommand(
					{
						name: 'quit',
						bindKey: {
							win: 'Alt-Q', mac: 'Command-Q',
							sender: 'editor|cli'
						},
						exec:$.proxy(
							function(env,args,request){
								editor.destroy();
								$(window.terminal).find("textarea").focus();
								window.terminal.focus();
								panel.close();
							},
							this
						)
					}
				)
				//--------------------------------------------------------------------------------
				//Theme - Next
				//--------------------------------------------------------------------------------
				var arr_theme=[
						"ambiance",
						"chaos",
						"chrome",
						"clouds",
						"clouds_midnight",
						"cobalt",
						"crimson_editor",
						"dawn",
						"dracula",
						"dreamweaver",
						"eclipse",
						"github",
						"gob",
						"gruvbox",
						"idle_fingers",
						"iplastic",
						"katzenmilch",
						"kr_theme",
						"kuroir",
						"merbivore",
						"merbivore_soft",
						"mono_industrial",
						"monokai",
						"pastel_on_dark",
						"solarized_dark",
						"solarized_light",
						"sqlserver",
						"terminal",
						"textmate",
						"tomorrow",
						"tomorrow_night",
						"tomorrow_night_blue",
						"tomorrow_night_bright",
						"tomorrow_night_eighties",
						"twilight",
						"vibrant_ink",
						"xcode",
					];
				var idx_theme=0;
				editor.commands.addCommand(
					{
						name:'Theme Next',
						bindKey: {
							win:'Alt-N',mac:'Command-N',
							sender:'editor|cli'
						},
						exec:$.proxy(
							function(env,args,request){
								idx_theme++;
								idx_theme%=arr_theme.length;
								editor.setTheme("ace/theme/"+arr_theme[idx_theme]);
							},
							this
						)
					}
				);
				//--------------------------------------------------------------------------------
				//Theme - Previous
				//--------------------------------------------------------------------------------
				editor.commands.addCommand(
					{
						name:'Theme Previous',
						bindKey: {
							win:'Alt-P',mac:'Command-P',
							sender:'editor|cli'
						},
						exec:$.proxy(
							function(env,args,request){
								console.log(idx_theme);
								idx_theme--;
								idx_theme=idx_theme<0?0:idx_theme;
								idx_theme%=arr_theme.length;
								editor.setTheme("ace/theme/"+arr_theme[idx_theme]);
							},
							this
						)
					}
				);
				if(args.file!=null){
					$.ajax(
						"/filepost.js",
						{
							data:JSON.stringify({'cmd':'open','file':args.file}),
							contentType:'application/json',
							type:'POST'
						}
					).done(
						$.proxy(function(data){
							editor.setValue(data);
						},this)
					).fail(
						$.proxy(function(e){
						},this)
					);
				}
			       window.editor=editor;
			}else{
				console.error('Failed to get parent node');
			}
		};
		<@ out.Println("main("+JSON.stringify({file:Parameters().Parameter('file')[0]})+");"); @>
	</script>
</div>


