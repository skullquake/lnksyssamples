#!/bin/env bash
printf "________________________________________\n"
printf "BUILD OUT TEMP TABLE\n"
printf "________________________________________\n"
curl\
	http://localhost:1111/lib/sjs/tst/db000.js\
	-X POST\
	-H "Content-type: application/json" \
	--data \
'{
	"action":"query",
	"params":{
		"fmt":"csv",
		"query":[
			"DO $$",
			"DECLARE",
			"    idx    integer:=0;",
			"    max    integer:=32;",
			"    deps   text[];",
			"    degs   text[];",
			"    fnams  text[];",
			"    lnams  text[];",
			"    fnam   varchar;",
			"    lnam   varchar;",
			"    deg    varchar;",
			"    depcod varchar;",
			"    depnam varchar;",
			"    depsch varchar;",
			"    depadr varchar;",
			"    depext varchar;",
			"    ndeps int;",
			"    last_emp_num integer;",
			"    last_dept_code varchar;",
			"BEGIN",
			"    fnams:= array[",
			"        $esc$'John'$esc$,",
			"        $esc$'Jane'$esc$,",
			"        $esc$'Jim'$esc$,",
			"        $esc$'Jenna'$esc$",
			"    ];",
			"    lnams:= array[",
			"        $esc$'McArthur'$esc$,",
			"        $esc$'Jameson'$esc$,",
			"        $esc$'Archer'$esc$,",
			"        $esc$'Schultz'$esc$,",
			"        $esc$'Gates'$esc$,",
			"        $esc$'Jameson'$esc$",
			"    ];",
			"    degs:= array[",
			"        $esc$'PH.D.'$esc$,",
			"        $esc$'MA'$esc$,",
			"        $esc$'DBA'$esc$,",
			"        $esc$'MBA'$esc$",
			"    ];",

			"    deps := array[",
			"        array[",
			"             $esc$'ACCT'$esc$,",
			"             $esc$'Accounting'$esc$,",
			"             $esc$'BUS'$esc$,",
			"             $esc$'KLR\ 211,Box\ 52'$esc$,",
			"             $esc$'3119'$esc$",
			"        ],",
			"        array[",
			"             $esc$'ART'$esc$,",
			"             $esc$'Fine\ Arts'$esc$,",
			"             $esc$'A\&SCI'$esc$,",
			"             $esc$'BBG\ 185,Box\ 128'$esc$,",
			"             $esc$'2278'$esc$",
			"        ],",
			"        array[",
			"             $esc$'BIOL'$esc$,",
			"             $esc$'Biology'$esc$,",
			"             $esc$'A\&SCI'$esc$,",
			"             $esc$'AAK\ 230,Box\ 415'$esc$,",
			"             $esc$'4117'$esc$",
			"        ],",
			"        array[",
			"             $esc$'CIS'$esc$,",
			"             $esc$'Computer\ Information\ Systems'$esc$,",
			"             $esc$'BUS'$esc$,",
			"             $esc$'KLR\ 333,Box\ 56'$esc$,",
			"             $esc$'3245'$esc$",
			"        ],",
			"        array[",
			"             $esc$'ECON/FIN'$esc$,",
			"             $esc$'Economics/Finance'$esc$,",
			"             $esc$'BUS'$esc$,",
			"             $esc$'KLR\ 284,Box\ 63'$esc$,",
			"             $esc$'3126'$esc$",
			"        ],",
			"        array[",
			"             $esc$'ENG'$esc$,",
			"             $esc$'English'$esc$,",
			"             $esc$'A\&SCI'$esc$,",
			"             $esc$'DRE\ 102,Box\ 223'$esc$,",
			"             $esc$'1004'$esc$",
			"        ],",
			"        array[",
			"             $esc$'HST'$esc$,",
			"             $esc$'History'$esc$,",
			"             $esc$'A\&SCI'$esc$,",
			"             $esc$'DRE\ 156,Box\ 284'$esc$,",
			"             $esc$'1867'$esc$",
			"        ],",
			"        array[",
			"             $esc$'MATH'$esc$,",
			"             $esc$'Mathematics'$esc$,",
			"             $esc$'A\&SCI'$esc$,",
			"             $esc$'AAK\ 194,Box\ 422'$esc$,",
			"             $esc$'4234'$esc$",
			"        ],",
			"        array[",
			"             $esc$'MKT/MGT'$esc$,",
			"             $esc$'Marketing\ and\ Management'$esc$,",
			"             $esc$'BUS'$esc$,",
			"             $esc$'KLR\ 126,Box\ 55'$esc$,",
			"             $esc$'3342'$esc$",
			"        ],",
			"        array[",
			"             $esc$'PSYCH'$esc$,",
			"             $esc$'Psychology'$esc$,",
			"             $esc$'A\&SCI'$esc$,",
			"             $esc$'AAK\ 297,Box\ 438'$esc$,",
			"             $esc$'4110'$esc$",
			"        ],",
			"        array[",
			"             $esc$'SOC'$esc$,",
			"             $esc$'Sociology'$esc$,",
			"             $esc$'A\&SCI'$esc$,",
			"             $esc$'BBG\ 208,Box\ 132'$esc$,",
			"             $esc$'2008'$esc$",
			"        ]",
			"    ];",
			"    ndeps:=array_length(deps,1);",
			"    create temporary table _tmp0(a int) on commit drop;",
			"    drop table if exists professor;",
			"    drop table if exists department;",
			"    create table if not exists professor(",
			"        emp_num int,",
			"        fnam varchar,",
			"        lnam varchar,",
			"        dept_code varchar,",
			"        prof_office varchar,",
			"        prof_extension int,",
			"        prof_high_degree varchar",
			"    );",
			"    create table if not exists department(",
			"        dept_code varchar,",
			"        dept_name varchar,",
			"        school_code varchar,",
			"        emp_num int,",
			"        dept_address varchar,",
			"        dept_extension varchar",
			"    );",
			"    LOOP",
			"        EXIT WHEN idx=ndeps;",
			"        fnam:=fnams[random()*array_length(fnams,1)+1];",
			"        lnam:=lnams[random()*array_length(lnams,1)+1];",
			"        deg:=degs[random()*array_length(degs,1)+1];",
			"        depcod:=deps[1+idx][1];",
			"        depnam:=deps[1+idx][2];",
			"        depsch:=deps[1+idx][3];",
			"        depadr:=deps[1+idx][4];",
			"        depext:=deps[1+idx][5];",
			"        insert into professor(",
			"            emp_num,",
			"            fnam,",
			"            lnam,",
			"            prof_high_degree",
			"        )values(",
			"            idx,",
			"            fnam,",
			"            lnam,",
			"            deg",
			"        ) returning emp_num into last_emp_num;",
			"        insert into department(",
			"            dept_code,",
			"            dept_name,",
			"            school_code,",
			"            dept_address,",
			"            dept_extension,",
			"            emp_num",
			"        ) values (",
			"            depcod,",
			"            depnam,",
			"            depsch,",
			"            depadr,",
			"            depext,",
			"            last_emp_num",
			"        ) returning dept_code into last_dept_code;",
			"        update professor set dept_code=last_dept_code where emp_num=last_emp_num;",
			"        idx=idx+1;",
			"    END LOOP;",
			"/*",
			"    create temporary table if not exists _tmp2 as (select * from professor) on commit drop;",
			"*/",
			"END $$;",
			"/* select from tmp table */",
			"/*",
			"select * from _tmp0;",
			"select * from department;",
			"*/",
			"select * from professor left outer join department on professor.emp_num=department.emp_num;",
			""
		],
		"args":{
		}
	}
}'
